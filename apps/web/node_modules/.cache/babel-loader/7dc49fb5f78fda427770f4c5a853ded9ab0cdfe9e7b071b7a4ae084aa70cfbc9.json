{"ast":null,"code":"const Page = require('../models/Page');\nconst mongoose = require('mongoose');\n\n// ========== ULTIMATE DASHBOARD FIX ==========\nconst getDashboardData = async (req, res) => {\n  console.log('üîç [DASHBOARD] START - User:', req.user);\n  try {\n    var _pages$;\n    // ‚úÖ FIX 1: ANY userId format OK\n    let userId;\n    if (mongoose.Types.ObjectId.isValid(req.user._id)) {\n      userId = new mongoose.Types.ObjectId(req.user._id);\n    } else {\n      userId = req.user._id; // String OK too\n    }\n    console.log('‚úÖ [DASHBOARD] userId:', userId, 'type:', typeof userId);\n\n    // ‚úÖ FIX 2: COUNT FIRST (DEBUG)\n    const totalCount = await Page.countDocuments({\n      user_id: userId\n    });\n    console.log('‚úÖ [DASHBOARD] TOTAL PAGES IN DB:', totalCount);\n    if (totalCount === 0) {\n      return res.json({\n        success: true,\n        data: {\n          stats: {\n            totalPages: 0,\n            totalViews: '0',\n            totalRevenue: '0M',\n            livePages: 0,\n            conversionRate: '0%'\n          },\n          pages: []\n        }\n      });\n    }\n\n    // 3. STATS\n    const stats = await Page.aggregate([{\n      $match: {\n        user_id: userId\n      }\n    }, {\n      $group: {\n        _id: null,\n        totalPages: {\n          $sum: 1\n        },\n        totalViews: {\n          $sum: {\n            $ifNull: ['$views', 0]\n          }\n        },\n        totalRevenue: {\n          $sum: {\n            $ifNull: ['$revenue', 0]\n          }\n        },\n        livePages: {\n          $sum: {\n            $cond: [{\n              $eq: ['$status', 'ƒê√É XU·∫§T B·∫¢N']\n            }, 1, 0]\n          }\n        }\n      }\n    }]);\n    const statResult = stats[0] || {\n      totalPages: 0,\n      totalViews: 0,\n      totalRevenue: 0,\n      livePages: 0\n    };\n    console.log('‚úÖ [DASHBOARD] Stats:', statResult);\n\n    // 4. PAGES LIST\n    const pages = await Page.find({\n      user_id: userId\n    }).select('name description status views revenue created_at screenshot_url url _id updated_at').sort({\n      updated_at: -1\n    }).limit(12).lean();\n    console.log('‚úÖ [DASHBOARD] Found pages:', pages.length);\n    console.log('First page:', (_pages$ = pages[0]) === null || _pages$ === void 0 ? void 0 : _pages$.name);\n    const formattedPages = pages.map(page => ({\n      id: page._id.toString(),\n      title: page.name || 'Untitled',\n      description: (page.description || '').substring(0, 80) + '...',\n      status: page.status || 'CH∆ØA XU·∫§T B·∫¢N',\n      statusVN: page.status === 'ƒê√É XU·∫§T B·∫¢N' ? 'LIVE' : 'DRAFT',\n      views: (page.views || 0).toLocaleString(),\n      revenue: ((page.revenue || 0) / 1000000).toFixed(1) + 'M',\n      created: new Date(page.created_at || Date.now()).toLocaleDateString('vi-VN'),\n      screenshot: page.screenshot_url || '/images/placeholder.jpg',\n      url: page.url || `/preview/${page._id.toString()}`\n    }));\n    console.log('‚úÖ [DASHBOARD] SUCCESS -', formattedPages.length, 'pages');\n    res.json({\n      success: true,\n      data: {\n        stats: {\n          totalPages: statResult.totalPages,\n          totalViews: statResult.totalViews.toLocaleString(),\n          totalRevenue: (statResult.totalRevenue / 1000000).toFixed(1) + 'M',\n          livePages: statResult.livePages,\n          conversionRate: statResult.totalViews ? (statResult.totalRevenue / statResult.totalViews * 100).toFixed(1) + '%' : '0%'\n        },\n        pages: formattedPages\n      }\n    });\n  } catch (error) {\n    var _req$user, _req$user2;\n    console.error('üö® [DASHBOARD] ERROR:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message,\n      debug: {\n        userId: (_req$user = req.user) === null || _req$user === void 0 ? void 0 : _req$user._id,\n        userIdType: typeof ((_req$user2 = req.user) === null || _req$user2 === void 0 ? void 0 : _req$user2._id),\n        stack: error.stack\n      }\n    });\n  }\n};\nmodule.exports = {\n  getDashboardData\n};","map":{"version":3,"names":["Page","require","mongoose","getDashboardData","req","res","console","log","user","_pages$","userId","Types","ObjectId","isValid","_id","totalCount","countDocuments","user_id","json","success","data","stats","totalPages","totalViews","totalRevenue","livePages","conversionRate","pages","aggregate","$match","$group","$sum","$ifNull","$cond","$eq","statResult","find","select","sort","updated_at","limit","lean","length","name","formattedPages","map","page","id","toString","title","description","substring","status","statusVN","views","toLocaleString","revenue","toFixed","created","Date","created_at","now","toLocaleDateString","screenshot","screenshot_url","url","error","_req$user","_req$user2","message","debug","userIdType","stack","module","exports"],"sources":["F:/landinghub-iconic/apps/web/src/components/UserDashboard.js"],"sourcesContent":["const Page = require('../models/Page');\r\nconst mongoose = require('mongoose');\r\n\r\n// ========== ULTIMATE DASHBOARD FIX ==========\r\nconst getDashboardData = async (req, res) => {\r\n    console.log('üîç [DASHBOARD] START - User:', req.user);\r\n\r\n    try {\r\n        // ‚úÖ FIX 1: ANY userId format OK\r\n        let userId;\r\n        if (mongoose.Types.ObjectId.isValid(req.user._id)) {\r\n            userId = new mongoose.Types.ObjectId(req.user._id);\r\n        } else {\r\n            userId = req.user._id; // String OK too\r\n        }\r\n\r\n        console.log('‚úÖ [DASHBOARD] userId:', userId, 'type:', typeof userId);\r\n\r\n        // ‚úÖ FIX 2: COUNT FIRST (DEBUG)\r\n        const totalCount = await Page.countDocuments({ user_id: userId });\r\n        console.log('‚úÖ [DASHBOARD] TOTAL PAGES IN DB:', totalCount);\r\n\r\n        if (totalCount === 0) {\r\n            return res.json({\r\n                success: true,\r\n                data: {\r\n                    stats: { totalPages: 0, totalViews: '0', totalRevenue: '0M', livePages: 0, conversionRate: '0%' },\r\n                    pages: []\r\n                }\r\n            });\r\n        }\r\n\r\n        // 3. STATS\r\n        const stats = await Page.aggregate([\r\n            { $match: { user_id: userId } },\r\n            {\r\n                $group: {\r\n                    _id: null,\r\n                    totalPages: { $sum: 1 },\r\n                    totalViews: { $sum: { $ifNull: ['$views', 0] } },\r\n                    totalRevenue: { $sum: { $ifNull: ['$revenue', 0] } },\r\n                    livePages: {\r\n                        $sum: { $cond: [{ $eq: ['$status', 'ƒê√É XU·∫§T B·∫¢N'] }, 1, 0] }\r\n                    }\r\n                }\r\n            }\r\n        ]);\r\n\r\n        const statResult = stats[0] || { totalPages: 0, totalViews: 0, totalRevenue: 0, livePages: 0 };\r\n        console.log('‚úÖ [DASHBOARD] Stats:', statResult);\r\n\r\n        // 4. PAGES LIST\r\n        const pages = await Page.find({ user_id: userId })\r\n            .select('name description status views revenue created_at screenshot_url url _id updated_at')\r\n            .sort({ updated_at: -1 })\r\n            .limit(12)\r\n            .lean();\r\n\r\n        console.log('‚úÖ [DASHBOARD] Found pages:', pages.length);\r\n        console.log('First page:', pages[0]?.name);\r\n\r\n        const formattedPages = pages.map(page => ({\r\n            id: page._id.toString(),\r\n            title: page.name || 'Untitled',\r\n            description: (page.description || '').substring(0, 80) + '...',\r\n            status: page.status || 'CH∆ØA XU·∫§T B·∫¢N',\r\n            statusVN: page.status === 'ƒê√É XU·∫§T B·∫¢N' ? 'LIVE' : 'DRAFT',\r\n            views: (page.views || 0).toLocaleString(),\r\n            revenue: ((page.revenue || 0) / 1000000).toFixed(1) + 'M',\r\n            created: new Date(page.created_at || Date.now()).toLocaleDateString('vi-VN'),\r\n            screenshot: page.screenshot_url || '/images/placeholder.jpg',\r\n            url: page.url || `/preview/${page._id.toString()}`\r\n        }));\r\n\r\n        console.log('‚úÖ [DASHBOARD] SUCCESS -', formattedPages.length, 'pages');\r\n\r\n        res.json({\r\n            success: true,\r\n            data: {\r\n                stats: {\r\n                    totalPages: statResult.totalPages,\r\n                    totalViews: statResult.totalViews.toLocaleString(),\r\n                    totalRevenue: (statResult.totalRevenue / 1000000).toFixed(1) + 'M',\r\n                    livePages: statResult.livePages,\r\n                    conversionRate: statResult.totalViews ? ((statResult.totalRevenue / statResult.totalViews) * 100).toFixed(1) + '%' : '0%'\r\n                },\r\n                pages: formattedPages\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('üö® [DASHBOARD] ERROR:', error);\r\n        res.status(500).json({\r\n            success: false,\r\n            message: error.message,\r\n            debug: {\r\n                userId: req.user?._id,\r\n                userIdType: typeof req.user?._id,\r\n                stack: error.stack\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nmodule.exports = { getDashboardData };"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}